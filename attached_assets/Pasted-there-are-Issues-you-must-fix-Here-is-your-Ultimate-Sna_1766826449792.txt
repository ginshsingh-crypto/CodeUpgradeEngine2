there are Issues you must fix, Here is your Ultimate Snag List to clear today.

1. The "Basil" Crash (Server Suicide)

File: server/stripeClient.ts (Line 51)

The Issue: apiVersion: '2025-08-27.basil' does not exist. Your server will crash immediately on startup.

The Fix: Change it to the stable version:

TypeScript

apiVersion: '2023-10-16',

2. The Admin "Backdoor" (Security)

File: server/index.ts (Line 12)

The Issue: const SUPER_ADMIN_EMAIL = ... || "ginshsingh@gmail.com";. If you forget to set the environment variable in production, that hardcoded email owns your data.

The Fix: Remove the fallback. Force the server to crash if the variable is missing.

TypeScript

if (!process.env.ADMIN_EMAIL) throw new Error("FATAL: ADMIN_EMAIL env var is not set");
const SUPER_ADMIN_EMAIL = process.env.ADMIN_EMAIL;

3. The Replit "Handcuff" (Vendor Lock)

File: server/objectStorage.ts

The Issue: Your code uses REPLIT_SIDECAR_ENDPOINT. This only works inside Replit. If you try to scale to AWS, Railway, or DigitalOcean later, file uploads will fail 100%.

The Fix: Refactor this file to use the standard Google Cloud Storage SDK initialization (which reads credentials from the GOOGLE_APPLICATION_CREDENTIALS env var) instead of the custom Replit sidecar fetch.

4. The Session Lockout (Day 1 Failure)

File: server/replitAuth.ts (Line 17)

The Issue: createTableIfMissing: false. If you deploy to a fresh database, the sessions table won't exist, and no one (including you) will be able to log in.

The Fix: Change to createTableIfMissing: true.


5. The "Slow Internet" Timeout (BIM Specific)

File: server/objectStorage.ts (Line 120)

The Issue: Signed upload URLs expire in 1 hour (ttlSec: 3600).

The Reality: A Saudi client on 4G uploading a 2GB Revit model will take > 1 hour. The upload will fail at 99% with 403 Forbidden.

The Fix: Increase ttlSec to 14400 (4 hours).


6. The Windows Upload Failure (Content-Type)

File: client/src/components/ObjectUploader.tsx

The Issue: Windows browsers often send zip files as application/x-zip-compressed. Your server signs the URL strictly for application/zip. GCS will reject the upload.

The Fix: Force the header in the frontend uploader config:

TypeScript

// In ObjectUploader.tsx config
headers: { 'Content-Type': 'application/zip' }, // Force strict type


7. The Build Failure (Compiler Error)

File: revit-addin/.../LOD400Uploader.csproj

The Issue: You use ZipFile in PackagingService but missed the required assembly reference. It will not compile.

The Fix: Add these lines inside the <ItemGroup> block in your .csproj:

XML

<Reference Include="System.IO.Compression" />
<Reference Include="System.IO.Compression.FileSystem" />


8. The "DLL Hell" Conflict (Crash on Launch)

File: LOD400Uploader.csproj

The Issue: You are shipping Newtonsoft.Json.dll. Revit also uses this DLL (an older version). When your plugin loads, Revit forces it to use the old version, crashing your plugin with MethodNotFound.

The Fix:

Option A (Manual): Rename your DLL to LOD400.Json.dll and update references.

Option B (Pro): Install the Costura.Fody NuGet package to embed dependencies inside your main DLL.


9. The "File Lock" Crash (Windows Physics)

File: Services/PackagingService.cs

The Issue: You use File.Copy for local files. Since the user has the file open in Revit, Windows locks it. This throws an IOException.

The Fix: Delete the if (local) block. Use document.Application.OpenDocumentFile (Detached) for ALL files. This reads the file into memory, bypassing the lock.

10. The "BIM 360" Path Crash (Logic Error)

File: Services/PackagingService.cs

The Issue: Path.GetDirectoryName(doc.PathName) throws an exception if the path is a URL (e.g., BIM 360://...).

The Fix: Wrap path resolution in a check: if (!IsCloudPath(doc.PathName)) { ... }.


11. The Hardcoded URL (Connection Failure)

File: App.cs (Line 98)

The Issue: Defaults to https://deepnewbim.com. If the installer script fails to write the config file (common with Antivirus), the plugin connects to a dead server.

The Fix: Change this string to your actual production URL (https://[your-app].replit.app).


12. The "Double Payment" Risk

File: Views/UploadDialog.xaml.cs

The Issue: If a client pays -> internet dies -> reopens plugin -> they are asked to pay again.

The Fix: In the UploadDialog constructor, call GET /api/addin/orders. If you find an order where Status == "paid" and UploadedAt == null, prompt: "Found a paid order pending upload. Resume?" and skip the payment screen.




The "Basil" Crash (Server Suicide)
Location: server/stripeClient.ts (Line 51) The Bug:

TypeScript

apiVersion: '2025-08-27.basil' as any, // <--- HALLUCINATION
The Reality: "2025-08-27.basil" is not a valid Stripe API version. It is a hallucination. The Consequence: When your server tries to initialize Stripe to process a payment, it will throw an Invalid API Version error and crash immediately. You will not be able to take money. The Fix: Delete that line or change it to a real version (e.g., '2023-10-16').

The "Lost Payment" Loophole (Business Risk)
The Scenario:

A client selects 50 sheets (7,500 SAR).

They pay. Stripe takes the money.

Immediately after paying, their internet flickers, or they accidentally close the window before the upload finishes.

The Bug: The current code has no "Resume" logic. When they open the Add-in again, it creates a NEW Order and asks them to pay 7,500 SAR again. The Consequence: Angry clients and chargebacks. The Fix: In UploadDialog.xaml.cs, on startup, call GetOrdersAsync(). If you find an order where Status == "paid" AND UploadedAt == null, show a popup: "Found an incomplete order. Resume upload?"


The "DLL Hell" (Revit Crash)
The Issue: You are bundling Newtonsoft.Json.dll with your Add-in. The Reality: Revit also uses Newtonsoft.Json.dll internally. The Crash: When Revit launches, it loads its own version (e.g., v11). When your plugin tries to load your version (v13), Revit blocks it. Your Add-in will crash instantly with a MethodNotFoundException. The Fix:

Simple: Rename your DLL to LOD400.Json.dll in the build folder before zipping.

Professional: Use a tool called ILRepack to merge the JSON library inside your main DLL so Revit doesn't see it.


The "Trojan Horse" (Security Hole)
Location: server/index.ts (Line 12) The Bug:

TypeScript

const SUPER_ADMIN_EMAIL = process.env.ADMIN_EMAIL || "ginshsingh@gmail.com";
The Reality: You have a hardcoded fallback email address. The Consequence: If you deploy this and forget to set the ADMIN_EMAIL environment variable (which happens often), that person (whoever owns that email) becomes the Super Admin of your business. They can see all your files and data. The Fix: Delete the fallback string immediately. Make the app crash if the variable is missing.

TypeScript

if (!process.env.ADMIN_EMAIL) throw new Error("ADMIN_EMAIL must be set!");





1. The "BIM 360" Path Crash (Logic Bug)
Location: revit-addin/LOD400Uploader/Services/PackagingService.cs The Bug: Your code attempts to resolve relative paths for linked files:

C#

string hostFolder = Path.GetDirectoryName(document.PathName); // <--- CRASH HAZARD
The Reality: For Big Contractors using BIM 360 or ACC, document.PathName is a URL (e.g., BIM 360://Project/Model.rvt). Windows Path functions crash if you feed them a URL. This will instantly crash the plugin for your highest-value clients.

The Fix: Wrap this logic in a check. Only try to resolve relative paths if the host model is actually on a local disk. In CollectLinkPaths, replace the path resolution block with:

C#

// FIX: Only resolve relative paths if the host is a local file (not cloud)
if (!Path.IsPathRooted(linkPath) 
    && !string.IsNullOrEmpty(document.PathName) 
    && !IsCloudPath(document.PathName)) 
{
    try 
    {
        string hostFolder = Path.GetDirectoryName(document.PathName);
        linkPath = Path.GetFullPath(Path.Combine(hostFolder, linkPath));
    }
    catch { /* Ignore path errors */ }
}
2. The "File In Use" Crash (Windows Physics)
Location: revit-addin/LOD400Uploader/Services/PackagingService.cs The Bug: In your local file logic (the else block), you use File.Copy:

C#

File.Copy(originalPath, data.ModelCopyPath, true); // <--- CRASH HAZARD
The Reality: The user has the file open in Revit when they click upload. Revit places a "Read/Write Lock" on the .rvt file. Windows will throw an IOException: The process cannot access the file... and the plugin will crash.

The Fix: Treat every model like a workshared model. Do not use File.Copy. Use Revit's internal API to open the file in memory (which bypasses the lock) and save a copy.

Action: Delete the entire if/else block in PreparePackageData. Run the "API Open/Save" logic (currently inside the if) for ALL files.

3. The "Hardcoded URL" Trap (Deployment Risk)
Location: revit-addin/LOD400Uploader/App.cs (Line 98) The Bug:

C#

return "https://deepnewbim.com"; // <--- RISK
The Reality: If your installer script fails to write the config.json file (due to antivirus or permissions on the user's PC), the Add-in defaults to deepnewbim.com. Unless you own that domain and have deployed there, the Add-in will fail to connect silently.

The Fix: Change this string to your actual deployed Replit URL (e.g., https://lod400-platform.replit.app) before you build. This is your safety net.





1. The Compile Error (Critical Code Fix)
Your PackagingService.cs uses ZipFile.CreateFromDirectory. In .NET Framework 4.8 (which Revit uses), this method resides in a specific assembly that is not referenced by default.

The Risk: If you try to build this solution, it will fail.





